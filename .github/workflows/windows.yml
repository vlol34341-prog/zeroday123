name: Ubuntu RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install XFCE and XRDP
        run: |
          # Mettre Ã  jour le systÃ¨me
          sudo apt-get update
          sudo apt-get upgrade -y

          # Installer XFCE (lÃ©ger et performant)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11

          # Installer XRDP
          sudo apt-get install -y xrdp

          # Configurer XRDP pour utiliser XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/

          # RedÃ©marrer XRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Ouvrir le port RDP
          sudo ufw allow 3389

      - name: Install Essential Tools
        run: |
          # Outils essentiels
          sudo apt-get install -y \
            firefox \
            filezilla \
            gedit \
            vim \
            htop \
            curl \
            wget \
            git \
            nano \
            fonts-noto \
            fonts-liberation

          # Nettoyer le cache
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Optimize Desktop Performance
        run: |
          # DÃ©sactiver les effets visuels pour amÃ©liorer les performances
          mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
          cat > ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="theme" type="string" value="Default"/>
              <property name="title_alignment" type="string" value="center"/>
              <property name="box_move" type="bool" value="true"/>
              <property name="box_resize" type="bool" value="true"/>
              <property name="snap_to_border" type="bool" value="true"/>
              <property name="snap_to_windows" type="bool" value="true"/>
              <property name="wrap_windows" type="bool" value="false"/>
              <property name="wrap_workspaces" type="bool" value="false"/>
              <property name="shadow_delta_height" type="int" value="0"/>
              <property name="shadow_delta_width" type="int" value="0"/>
              <property name="shadow_delta_x" type="int" value="0"/>
              <property name="shadow_delta_y" type="int" value="-3"/>
              <property name="shadow_opacity" type="int" value="50"/>
              <property name=" Compositor">
                <property name="max_fps" type="uint" value="30"/>
              </property>
            </property>
          </channel>
          EOF

          # Configurer XFCE pour de meilleures performances
          dbus-launch xfconf-query -c xfwm4 -p /general/use_compositing -s false
          dbus-launch xfconf-query -c xfce4-session -p /general/SaveOnExit -s false

      - name: Create RDP User
        run: |
          # CrÃ©er un utilisateur dÃ©diÃ© pour RDP
          sudo useradd -m -s /bin/bash ubuntuuser
          echo "ubuntuuser:$(openssl rand -base64 16)" | sudo chpasswd
          
          # Ajouter aux groupes nÃ©cessaires
          sudo usermod -aG sudo ubuntuuser
          sudo usermod -aG xrdp ubuntuuser
          
          # Configurer l'environnement pour l'utilisateur
          sudo -u ubuntuuser mkdir -p /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml
          sudo -u ubuntuuser cp ~/.xsession /home/ubuntuuser/
          sudo -u ubuntuuser cp ~/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/
          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser

          # Stocker les identifiants
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$(openssl rand -base64 16)" | sudo tee /tmp/password.txt
          echo "RDP_PASSWORD=$(cat /tmp/password.txt)" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          # Installer Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # DÃ©marrer Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gh-runner-${{ github.run_id }}

          # Attendre l'IP Tailscale
          sleep 10
          TS_IP=$(sudo tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Configure XRDP Security
        run: |
          # Configurer XRDP pour accepter les connexions distantes
          sudo sed -i 's/port=3389/port=3389\naddress=0.0.0.0/g' /etc/xrdp/xrdp.ini
          
          # AmÃ©liorer les performances XRDP
          sudo sed -i 's/use_compression=yes/use_compression=no/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          
          # RedÃ©marrer XRDP
          sudo systemctl restart xrdp

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================"
          echo "ðŸš€ UBUNTU RDP ACCESS READY - OPTIMIZED"
          echo "================================================"
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "================================================"
          echo "RECOMMENDED SETTINGS:"
          echo "- Client: Microsoft Remote Desktop"
          echo "- Resolution: 1280x720 or 1920x1080"
          echo "- Color: 24-bit"
          echo "- Experience: LAN (10 Mbps+)"
          echo "================================================"
          echo ""

      - name: Keep Session Active
        run: |
          echo "âœ… Ubuntu RDP Session Active"
          echo "Desktop: XFCE (Lightweight)"
          echo "Press 'Cancel' in GitHub to terminate"
          
          # Garder la session active
          while true; do
            echo "$(date): Session active - XRDP running on port 3389"
            sleep 60
          done
