name: Ubuntu RDP Fixed Login

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install Ubuntu Desktop and XRDP
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          
          # Installer le desktop Ubuntu minimal avec XFCE
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            ubuntu-desktop-minimal \
            xfce4 \
            xfce4-goodies \
            xorg \
            dbus-x11 \
            xrdp \
            xorgxrdp

      - name: Fix XRDP Configuration
        run: |
          # ArrÃªter XRDP pour reconfiguration
          sudo systemctl stop xrdp
          sudo systemctl stop xrdp-sesman

          # Configuration corrigÃ©e de XRDP
          sudo tee /etc/xrdp/xrdp.ini > /dev/null << 'EOF'
          [globals]
          bitmap_cache=yes
          bitmap_compression=yes
          port=3389
          crypt_level=low
          channel_code=1
          max_bpp=24
          use_compression=no
          
          [xrdp1]
          name=sesman-Xvnc
          lib=libvnc.so
          username=ask
          password=ask
          ip=127.0.0.1
          port=-1
          EOF

          # Configuration de sesman
          sudo tee /etc/xrdp/sesman.ini > /dev/null << 'EOF'
          [Globals]
          ListenAddress=127.0.0.1
          ListenPort=3350
          EnableUserWindowManager=1
          UserWindowManager=startxfce4
          DefaultWindowManager=startxfce4
          
          [Security]
          AllowRootLogin=1
          MaxLoginRetry=4
          
          [Sessions]
          MaxSessions=10
          KillDisconnected=0
          DisconnectedTimeLimit=0
          IdleTimeLimit=0
          
          [X11rdp]
          param1=-bs
          param2=-ac
          param3=-nolisten
          param4=tcp
          
          [Xvnc]
          param1=-bs
          param2=-ac
          param3=-nolisten
          param4=tcp
          param5=-localhost
          param6=-dpi
          param7=96
          EOF

      - name: Create and Configure User
        run: |
          # CrÃ©er l'utilisateur avec home directory
          sudo useradd -m -s /bin/bash -G sudo,xrdp ubuntuuser
          echo "ubuntuuser:Walid123@@" | sudo chpasswd
          
          # Configurer l'environnement desktop
          sudo mkdir -p /home/ubuntuuser/.local/share/xrdp
          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser
          
          # CrÃ©er le fichier Xsession
          sudo tee /home/ubuntuuser/.xsession << 'EOF'
          #!/bin/bash
          export XDG_SESSION_TYPE=x11
          export GDK_BACKEND=x11
          export XDG_CURRENT_DESKTOP=XFCE
          export XDG_SESSION_DESKTOP=xfce
          exec startxfce4
          EOF
          
          sudo chmod +x /home/ubuntuuser/.xsession
          sudo chown ubuntuuser:ubuntuuser /home/ubuntuuser/.xsession

      - name: Fix Permissions and Services
        run: |
          # RÃ©parer les permissions
          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser
          sudo usermod -a -G ssl-cert xrdp
          
          # RedÃ©marrer les services dans le bon ordre
          sudo systemctl daemon-reload
          sudo systemctl enable xrdp
          sudo systemctl start xrdp-sesman
          sudo systemctl start xrdp

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-rdp-${{ github.run_id }}
          sleep 10
          TS_IP=$(sudo tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=Walid123@@" >> $GITHUB_ENV

      - name: Final Setup and Test
        run: |
          # Ouvrir le port
          sudo ufw allow 3389
          
          # VÃ©rifier que les services tournent
          sudo systemctl status xrdp --no-pager
          sudo systemctl status xrdp-sesman --no-pager
          
          # Test local de XRDP
          echo "Testing XRDP locally..."
          netstat -tlnp | grep 3389 || echo "XRDP port not listening"

      - name: Display Connection Instructions
        run: |
          echo ""
          echo "================================================"
          echo "ðŸš€ UBUNTU RDP FIXED - READY TO CONNECT"
          echo "================================================"
          echo "IP: $TAILSCALE_IP"
          echo "Username: ubuntuuser"
          echo "Password: Walid123@@"
          echo ""
          echo "ðŸ“ IMPORTANT - SESSION SELECTION:"
          echo "Dans le menu session, choisir:"
          echo "âœ… 'Xorg' ou 'X11rdp'"
          echo ""
          echo "ðŸ”§ Si Ã§a ne marche pas, essayer cette commande:"
          echo "sudo systemctl restart xrdp xrdp-sesman"
          echo "================================================"

      - name: Keep Alive
        run: |
          echo "âœ… RDP Session Active - Monitoring..."
          counter=0
          while true; do
            counter=$((counter + 1))
            # VÃ©rifier que XRDP tourne toujours
            if ! sudo systemctl is-active xrdp > /dev/null; then
              echo "ðŸ”„ Restarting XRDP..."
              sudo systemctl restart xrdp
            fi
            echo "[$(date +%H:%M:%S)] RDP actif - $counter minutes"
            sleep 60
          done
