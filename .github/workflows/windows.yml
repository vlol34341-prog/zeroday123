name: Ubuntu RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install XFCE and XRDP
        run: |
          # Mettre à jour le système
          sudo apt-get update
          sudo apt-get upgrade -y

          # Installer XFCE (léger et performant)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11

          # Installer XRDP
          sudo apt-get install -y xrdp

          # Configurer XRDP pour utiliser XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/

          # Redémarrer XRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Ouvrir le port RDP
          sudo ufw allow 3389

      - name: Install Essential Tools
        run: |
          # Outils essentiels
          sudo apt-get install -y \
            firefox \
            filezilla \
            gedit \
            vim \
            htop \
            curl \
            wget \
            git \
            nano \
            fonts-noto \
            fonts-liberation

          # Nettoyer le cache
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Create RDP User
        run: |
          # Créer un utilisateur dédié pour RDP
          sudo useradd -m -s /bin/bash ubuntuuser
          PASSWORD=$(openssl rand -base64 16 | tr -d '/+' | cut -c1-16)
          echo "ubuntuuser:$PASSWORD" | sudo chpasswd
          
          # Ajouter aux groupes nécessaires
          sudo usermod -aG sudo ubuntuuser
          sudo usermod -aG xrdp ubuntuuser
          
          # Configurer l'environnement pour l'utilisateur
          sudo -u ubuntuuser bash -c "echo 'xfce4-session' > /home/ubuntuuser/.xsession"
          
          # Créer les fichiers de configuration XFCE optimisés
          sudo mkdir -p /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # Configuration XFWM4 pour désactiver les effets
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="theme" type="string" value="Default"/>
              <property name="use_compositing" type="bool" value="false"/>
              <property name="title_alignment" type="string" value="center"/>
              <property name="snap_to_border" type="bool" value="true"/>
              <property name="snap_to_windows" type="bool" value="true"/>
            </property>
          </channel>
          EOF

          # Configuration pour désactiver les effets de session
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-session" version="1.0">
            <property name="general" type="empty">
              <property name="SaveOnExit" type="bool" value="false"/>
            </property>
          </channel>
          EOF

          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser

          # Stocker les identifiants
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          # Installer Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # Démarrer Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gh-runner-${{ github.run_id }} --accept-routes

          # Attendre l'IP Tailscale
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Waiting for Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Configure XRDP Performance
        run: |
          # Sauvegarder la configuration originale
          sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.backup

          # Modifier les paramètres de performance (méthode sûre avec sed)
          sudo sed -i 's/use_compression=yes/use_compression=no/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/bitmap_compression=true/bitmap_compression=false/g' /etc/xrdp/xrdp.ini
          
          # Ajouter l'adresse d'écoute si pas présente
          sudo grep -q "address=0.0.0.0" /etc/xrdp/xrdp.ini || echo "address=0.0.0.0" | sudo tee -a /etc/xrdp/xrdp.ini

          # Redémarrer XRDP doucement
          sudo systemctl daemon-reload
          sudo systemctl restart xrdp || (echo "XRDP restart failed, showing status:" && sudo systemctl status xrdp && exit 
