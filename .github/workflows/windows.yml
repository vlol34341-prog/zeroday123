name: Ubuntu RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install XFCE and XRDP
        run: |
          # Mettre Ã  jour le systÃ¨me
          sudo apt-get update
          sudo apt-get upgrade -y

          # Installer XFCE (lÃ©ger et performant)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11

          # Installer XRDP
          sudo apt-get install -y xrdp

          # Configurer XRDP pour utiliser XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/

          # RedÃ©marrer XRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Ouvrir le port RDP
          sudo ufw allow 3389

      - name: Install Essential Tools
        run: |
          # Outils essentiels
          sudo apt-get install -y \
            firefox \
            filezilla \
            gedit \
            vim \
            htop \
            curl \
            wget \
            git \
            nano \
            fonts-noto \
            fonts-liberation

          # Nettoyer le cache
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Create RDP User
        run: |
          # CrÃ©er un utilisateur dÃ©diÃ© pour RDP
          sudo useradd -m -s /bin/bash ubuntuuser
          PASSWORD=$(openssl rand -base64 16 | tr -d '/+' | cut -c1-16)
          echo "ubuntuuser:$PASSWORD" | sudo chpasswd
          
          # Ajouter aux groupes nÃ©cessaires
          sudo usermod -aG sudo ubuntuuser
          sudo usermod -aG xrdp ubuntuuser
          
          # Configurer l'environnement pour l'utilisateur
          sudo -u ubuntuuser bash -c "echo 'xfce4-session' > /home/ubuntuuser/.xsession"
          
          # CrÃ©er les fichiers de configuration XFCE optimisÃ©s
          sudo mkdir -p /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # Configuration XFWM4 pour dÃ©sactiver les effets
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="theme" type="string" value="Default"/>
              <property name="use_compositing" type="bool" value="false"/>
              <property name="title_alignment" type="string" value="center"/>
              <property name="snap_to_border" type="bool" value="true"/>
              <property name="snap_to_windows" type="bool" value="true"/>
            </property>
          </channel>
          EOF

          # Configuration pour dÃ©sactiver les effets de session
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-session" version="1.0">
            <property name="general" type="empty">
              <property name="SaveOnExit" type="bool" value="false"/>
            </property>
          </channel>
          EOF

          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser

          # Stocker les identifiants
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          # Installer Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # DÃ©marrer Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gh-runner-${{ github.run_id }} --accept-routes

          # Attendre l'IP Tailscale
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Waiting for Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Configure XRDP Performance
        run: |
          # Sauvegarder la configuration originale
          sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.backup

          # Modifier les paramÃ¨tres de performance (mÃ©thode sÃ»re avec sed)
          sudo sed -i 's/use_compression=yes/use_compression=no/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/bitmap_compression=true/bitmap_compression=false/g' /etc/xrdp/xrdp.ini
          
          # Ajouter l'adresse d'Ã©coute si pas prÃ©sente
          if ! sudo grep -q "address=0.0.0.0" /etc/xrdp/xrdp.ini; then
            echo "address=0.0.0.0" | sudo tee -a /etc/xrdp/xrdp.ini
          fi

          # RedÃ©marrer XRDP
          sudo systemctl daemon-reload
          sudo systemctl restart xrdp
          
          # VÃ©rifier le statut
          echo "XRDP status:"
          sudo systemctl status xrdp --no-pager

      - name: Additional Performance Tweaks
        run: |
          # DÃ©sactiver les services inutiles
          sudo systemctl disable bluetooth --now || true
          sudo systemctl disable cups --now || true
          sudo systemctl disable avahi-daemon --now || true
          
          # Optimiser la mÃ©moire
          echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
          echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================"
          echo "ðŸš€ UBUNTU RDP ACCESS READY - OPTIMIZED"
          echo "================================================"
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "================================================"
          echo "DESKTOP: XFCE (Ultra Lightweight)"
          echo "PERFORMANCE: Compositing disabled"
          echo "RECOMMENDED CLIENT SETTINGS:"
          echo "- Resolution: 1280x720"
          echo "- Color: 24-bit"
          echo "- Experience: LAN (10 Mbps+)"
          echo "================================================"
          echo ""

      - name: Keep Session Active (Guaranteed)
        run: |
          echo "ðŸ”µ Starting RDP keep-alive session..."
          echo "âœ… All services are running"
          echo "ðŸ–¥ï¸  RDP accessible at: $TAILSCALE_IP"
          echo "ðŸ‘¤ Username: $RDP_USER"
          echo "ðŸ”‘ Password: $RDP_PASSWORD"
          echo ""
          echo "ðŸ“¡ Services status:"
          sudo systemctl is-active xrdp && echo "âœ… XRDP: ACTIVE" || echo "âŒ XRDP: INACTIVE"
          sudo tailscale status && echo "âœ… Tailscale: ACTIVE" || echo "âŒ Tailscale: INACTIVE"
          echo ""
          echo "â° Session started at: $(date)"
          echo "ðŸ”„ This session will remain active until manually cancelled"
          echo "âŒ To stop: Click 'Cancel workflow' in GitHub Actions"
          echo ""
          
          # Fonction de monitoring des services
          monitor_services() {
            while true; do
              if ! sudo systemctl is-active xrdp > /dev/null; then
                echo "âš ï¸  XRDP stopped, restarting..."
                sudo systemctl restart xrdp
              fi
              
              if ! sudo tailscale status > /dev/null 2>&1; then
                echo "âš ï¸  Tailscale disconnected, reconnecting..."
                sudo tailscale up --reset
              fi
              sleep 30
            done
          }
          
          # DÃ©marrer le monitoring en arriÃ¨re-plan
          monitor_services &
          MONITOR_PID=$!
          
          # Main keep-alive loop avec heartbeat
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER + 1))
            CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            echo "ðŸ’“ [${CURRENT_TIME}] RDP Session Active - ${COUNTER} minutes elapsed"
            
            # Afficher l'Ã©tat des services toutes les 5 minutes
            if [ $((COUNTER % 5)) -eq 0 ]; then
              echo "ðŸ“Š Service Status:"
              echo "   XRDP: $(sudo systemctl is-active xrdp)"
              echo "   Tailscale: $(sudo tailscale status > /dev/null 2>&1 && echo 'connected' || echo 'disconnected')"
              echo "   IP: $(sudo tailscale ip -4 2>/dev/null || echo 'unknown')"
            fi
            
            sleep 60
          done
          
          # Nettoyer le processus de monitoring si on sort de la boucle
          kill $MONITOR_PID 2>/dev/null || true
