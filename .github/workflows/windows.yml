name: Ubuntu RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install XFCE and XRDP
        run: |
          # Mettre Ã  jour le systÃ¨me
          sudo apt-get update
          sudo apt-get upgrade -y

          # Installer XFCE (lÃ©ger et performant)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11

          # Installer XRDP
          sudo apt-get install -y xrdp

          # Configurer XRDP pour utiliser XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/

          # RedÃ©marrer XRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Ouvrir le port RDP
          sudo ufw allow 3389

      - name: Install Essential Tools
        run: |
          # Outils essentiels
          sudo apt-get install -y \
            firefox \
            filezilla \
            gedit \
            vim \
            htop \
            curl \
            wget \
            git \
            nano \
            fonts-noto \
            fonts-liberation

          # Nettoyer le cache
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Optimize Desktop Performance
        run: |
          # Configurer XFCE pour de meilleures performances (mÃ©thode corrigÃ©e)
          mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # CrÃ©er le fichier de configuration XFWM4 avec --create
          xfconf-query -c xfwm4 -p /general/use_compositing -s false --create -t bool
          xfconf-query -c xfwm4 -p /general/theme -s "Default" --create -t string
          
          # DÃ©sactiver la sauvegarde de session
          xfconf-query -c xfce4-session -p /general/SaveOnExit -s false --create -t bool
          
          # Configurer pour performances
          xfconf-query -c xfwm4 -p /general/title_font -s "Sans 10" --create -t string
          xfconf-query -c xfwm4 -p /general/title_alignment -s "center" --create -t string

      - name: Create RDP User
        run: |
          # CrÃ©er un utilisateur dÃ©diÃ© pour RDP
          sudo useradd -m -s /bin/bash ubuntuuser
          PASSWORD=$(openssl rand -base64 16 | tr -d '/+' | cut -c1-16)
          echo "ubuntuuser:$PASSWORD" | sudo chpasswd
          
          # Ajouter aux groupes nÃ©cessaires
          sudo usermod -aG sudo ubuntuuser
          sudo usermod -aG xrdp ubuntuuser
          
          # Configurer l'environnement pour l'utilisateur
          sudo -u ubuntuuser mkdir -p /home/ubuntuuser/.config/xfce4
          sudo -u ubuntuuser bash -c "echo 'xfce4-session' > /home/ubuntuuser/.xsession"
          
          # Appliquer les optimisations pour l'utilisateur
          sudo -u ubuntuuser xfconf-query -c xfwm4 -p /general/use_compositing -s false --create -t bool
          sudo -u ubuntuuser xfconf-query -c xfwm4 -p /general/theme -s "Default" --create -t string
          
          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser

          # Stocker les identifiants
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          # Installer Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # DÃ©marrer Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gh-runner-${{ github.run_id }}

          # Attendre l'IP Tailscale
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Waiting for Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Configure XRDP Security
        run: |
          # Configurer XRDP pour accepter les connexions distantes
          sudo sed -i 's/port=3389/port=3389\naddress=0.0.0.0/g' /etc/xrdp/xrdp.ini
          
          # AmÃ©liorer les performances XRDP
          sudo sed -i 's/use_compression=yes/use_compression=no/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/bitmap_compression=true/bitmap_compression=false/g' /etc/xrdp/xrdp.ini
          
          # RedÃ©marrer XRDP
          sudo systemctl restart xrdp
          sudo systemctl status xrdp

      - name: Additional Performance Tweaks
        run: |
          # DÃ©sactiver les services inutiles pour libÃ©rer des ressources
          sudo systemctl disable bluetooth --now || true
          sudo systemctl disable cups --now || true
          sudo systemctl disable avahi-daemon --now || true

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================"
          echo "ðŸš€ UBUNTU RDP ACCESS READY - OPTIMIZED"
          echo "================================================"
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "================================================"
          echo "DESKTOP: XFCE (Lightweight)"
          echo "RECOMMENDED CLIENT SETTINGS:"
          echo "- Resolution: 1280x720"
          echo "- Color: 24-bit"
          echo "- Experience: LAN (10 Mbps+)"
          echo "- Disable wallpaper and animations"
          echo "================================================"
          echo ""

      - name: Keep Session Active
        run: |
          echo "âœ… Ubuntu RDP Session Active"
          echo "Press 'Cancel' in GitHub to terminate"
          echo "XRDP is running on port 3389"
          
          # VÃ©rifier que les services sont actifs
          sudo systemctl status xrdp --no-pager
          sudo tailscale status
          
          # Garder la session active
          counter=0
          while true; do
            counter=$((counter + 1))
            echo "$(date): Session active - $counter minutes elapsed"
            sleep 60
          done
