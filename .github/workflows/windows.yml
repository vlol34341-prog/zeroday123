name: Ubuntu RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 3600

    steps:
      - name: Install XFCE and XRDP
        run: |
          # Mettre √† jour le syst√®me
          sudo apt-get update
          sudo apt-get upgrade -y

          # Installer XFCE (l√©ger et performant)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xorg dbus-x11

          # Installer XRDP
          sudo apt-get install -y xrdp

          # Configurer XRDP pour utiliser XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/

          # Red√©marrer XRDP
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          # Ouvrir le port RDP
          sudo ufw allow 3389

      - name: Install Essential Tools
        run: |
          # Outils essentiels
          sudo apt-get install -y \
            firefox \
            filezilla \
            gedit \
            vim \
            htop \
            curl \
            wget \
            git \
            nano \
            fonts-noto \
            fonts-liberation

          # Nettoyer le cache
          sudo apt-get autoremove -y
          sudo apt-get clean

      - name: Create RDP User with Simple Password
        run: |
          # Cr√©er un utilisateur d√©di√© pour RDP avec mot de passe simple
          sudo useradd -m -s /bin/bash ubuntuuser
          echo "ubuntuuser:Walid123@@" | sudo chpasswd
          
          # Ajouter aux groupes n√©cessaires
          sudo usermod -aG sudo ubuntuuser
          sudo usermod -aG xrdp ubuntuuser
          
          # Configurer l'environnement pour l'utilisateur
          sudo -u ubuntuuser bash -c "echo 'xfce4-session' > /home/ubuntuuser/.xsession"
          
          # Cr√©er les fichiers de configuration XFCE optimis√©s
          sudo mkdir -p /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # Configuration XFWM4 pour d√©sactiver les effets
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="theme" type="string" value="Default"/>
              <property name="use_compositing" type="bool" value="false"/>
              <property name="title_alignment" type="string" value="center"/>
              <property name="snap_to_border" type="bool" value="true"/>
              <property name="snap_to_windows" type="bool" value="true"/>
            </property>
          </channel>
          EOF

          # Configuration pour d√©sactiver les effets de session
          sudo cat > /home/ubuntuuser/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-session" version="1.0">
            <property name="general" type="empty">
              <property name="SaveOnExit" type="bool" value="false"/>
            </property>
          </channel>
          EOF

          sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser

          # Stocker les identifiants
          echo "RDP_USER=ubuntuuser" >> $GITHUB_ENV
          echo "RDP_PASSWORD=Walid123@@" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          # Installer Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh

          # D√©marrer Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ubuntu-gh-runner-${{ github.run_id }} --accept-routes

          # Attendre l'IP Tailscale
          sleep 15
          TS_IP=$(sudo tailscale ip -4)
          if [ -z "$TS_IP" ]; then
            echo "Waiting for Tailscale IP..."
            sleep 10
            TS_IP=$(sudo tailscale ip -4)
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Configure XRDP Performance
        run: |
          # Sauvegarder la configuration originale
          sudo cp /etc/xrdp/xrdp.ini /etc/xrdp/xrdp.ini.backup

          # Modifier les param√®tres de performance (m√©thode s√ªre avec sed)
          sudo sed -i 's/use_compression=yes/use_compression=no/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/max_bpp=32/max_bpp=24/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/bitmap_compression=true/bitmap_compression=false/g' /etc/xrdp/xrdp.ini
          
          # Ajouter l'adresse d'√©coute si pas pr√©sente
          if ! sudo grep -q "address=0.0.0.0" /etc/xrdp/xrdp.ini; then
            echo "address=0.0.0.0" | sudo tee -a /etc/xrdp/xrdp.ini
          fi

          # Red√©marrer XRDP
          sudo systemctl daemon-reload
          sudo systemctl restart xrdp
          
          # V√©rifier le statut
          echo "XRDP status:"
          sudo systemctl status xrdp --no-pager

      - name: Additional Performance Tweaks
        run: |
          # D√©sactiver les services inutiles
          sudo systemctl disable bluetooth --now || true
          sudo systemctl disable cups --now || true
          sudo systemctl disable avahi-daemon --now || true

      - name: Display Connection Information
        run: |
          echo ""
          echo "================================================"
          echo "üöÄ UBUNTU RDP ACCESS READY"
          echo "================================================"
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: Walid123@@"
          echo "================================================"
          echo "DESKTOP: XFCE (Lightweight)"
          echo "RECOMMENDED CLIENT SETTINGS:"
          echo "- Resolution: 1280x720"
          echo "- Color: 24-bit"
          echo "- Experience: LAN (10 Mbps+)"
          echo "================================================"
          echo ""

      - name: Keep Session Active
        run: |
          echo "‚úÖ Starting RDP session..."
          echo "üñ•Ô∏è  RDP accessible at: $TAILSCALE_IP"
          echo "üë§ Username: ubuntuuser"
          echo "üîë Password: Walid123@@"
          echo ""
          echo "‚è∞ Session started at: $(date)"
          echo "üîÑ This session will remain active until manually cancelled"
          echo "‚ùå To stop: Click 'Cancel workflow' in GitHub Actions"
          echo ""
          
          # Main keep-alive loop
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER + 1))
            CURRENT_TIME=$(date '+%H:%M:%S')
            echo "[${CURRENT_TIME}] RDP Session Active - ${COUNTER} minutes"
            sleep 60
          done
